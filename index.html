<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FoodLens Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 16px;
      margin: 0;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 { 
      color: #333; 
      text-align: center;
      margin-bottom: 8px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 24px;
      font-size: 14px;
    }
    .upload-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, button {
      padding: 12px;
      font-size: 16px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="file"] {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #fafafa;
    }
    button {
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover {
      background: #006ba3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .results {
      margin-top: 20px;
    }
    .food-items {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .food-item:last-child {
      border-bottom: none;
    }
    .food-name {
      font-weight: 500;
      color: #333;
    }
    .confidence {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .recipes {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .recipe {
      padding: 16px;
      border-bottom: 1px solid #eee;
    }
    .recipe:last-child {
      border-bottom: none;
    }
    .recipe-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .recipe-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .recipe-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .cooking-time {
      background: #f0f9ff;
      color: #0369a1;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    .ingredients {
      margin-bottom: 12px;
    }
    .ingredients-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    .ingredients-list {
      color: #666;
      font-size: 13px;
    }
    .instructions {
      font-size: 13px;
    }
    .instructions-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .instruction-step {
      color: #666;
      margin-bottom: 4px;
      padding-left: 16px;
      position: relative;
    }
    .instruction-step:before {
      content: counter(step-counter);
      counter-increment: step-counter;
      position: absolute;
      left: 0;
      background: #0088cc;
      color: white;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      font-size: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      top: 2px;
    }
    .instructions {
      counter-reset: step-counter;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0088cc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
    }
    #recognizedIngredients {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .ingredient-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 4px 0;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    .ingredient-item.editing {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    .ingredient-item.used-in-recipe {
      background: #e8f5e8;
      border-color: #4caf50;
    }
    .ingredient-name {
      flex: 1;
      font-weight: 500;
      color: #333;
    }
    .ingredient-confidence {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      margin-right: 8px;
    }
    .ingredient-input {
      flex: 1;
      border: none;
      background: transparent;
      font-weight: 500;
      color: #333;
      padding: 4px;
      font-size: 14px;
    }
    .ingredient-actions {
      display: flex;
      gap: 8px;
    }
    .ingredient-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      width: auto;
      margin: 0;
    }
    .edit-btn {
      background: #e3f2fd;
      color: #1976d2;
    }
    .save-btn {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .delete-btn {
      background: #ffebee;
      color: #c62828;
    }
    .used-check {
      color: #4caf50;
      font-size: 16px;
      margin-right: 8px;
    }
    .add-ingredient {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .add-ingredient input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin: 0;
    }
    .add-ingredient button {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 0;
      width: auto;
    }
    .generate-recipes-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      width: 100%;
      margin-top: 16px;
    }
    .generate-recipes-btn:hover {
      background: #218838;
    }
    .generate-recipes-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üçΩ FoodLens</h1>
    <p class="subtitle">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç—ã!</p>
    
    <div class="upload-section">
      <div id="serviceStatus" style="display: none;"></div>
      <input id="photoInput" type="file" accept="image/*" capture="environment" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ">
      <button id="uploadBtn">üì∑ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</button>
      <div id="status"></div>
    </div>

    <div id="results" class="results" style="display: none;">
      <div id="recognizedIngredients" style="display: none;">
        <div class="section-title">
          ü•ó –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
        </div>
        <div id="ingredientsList"></div>
        <div class="add-ingredient">
          <input type="text" id="newIngredient" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç...">
          <button onclick="addIngredient()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <button id="generateRecipesBtn" class="generate-recipes-btn" onclick="generateRecipes()">
          üë®‚Äçüç≥ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã
        </button>
      </div>

      <div id="recipes" style="display: none;">
        <div class="section-title">
          üë®‚Äçüç≥ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã
        </div>
        <div class="recipes" id="recipeList"></div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–≥–æ ngrok-—Ç—É–Ω–Ω–µ–ª—è
    const SERVER_URL = 'https://8838f8430a6a.ngrok-free.app';

    const uploadBtn = document.getElementById('uploadBtn');
    const statusEl = document.getElementById('status');
    const serviceStatusEl = document.getElementById('serviceStatus');
    const resultsEl = document.getElementById('results');
    const recognizedIngredientsEl = document.getElementById('recognizedIngredients');
    const recipesEl = document.getElementById('recipes');
    const ingredientsListEl = document.getElementById('ingredientsList');
    const recipeListEl = document.getElementById('recipeList');
    const generateRecipesBtnEl = document.getElementById('generateRecipesBtn');

    // Global variables
    let currentIngredients = [];
    let ingredientConfidences = {}; // Store confidence scores
    let usedIngredients = new Set(); // Track which ingredients are used in recipes
    let currentFilename = '';

    // Russian translation map for food items
    const foodTranslations = {
      'mixed food': '–°–º–µ—à–∞–Ω–Ω–∞—è –µ–¥–∞',
      'vegetables': '–û–≤–æ—â–∏',
      'fruits': '–§—Ä—É–∫—Ç—ã',
      'bread': '–•–ª–µ–±',
      'dairy': '–ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã',
      'meat': '–ú—è—Å–æ',
      'fish': '–†—ã–±–∞',
      'eggs': '–Ø–π—Ü–∞',
      'cheese': '–°—ã—Ä',
      'milk': '–ú–æ–ª–æ–∫–æ',
      'butter': '–ú–∞—Å–ª–æ',
      'pasta': '–ú–∞–∫–∞—Ä–æ–Ω—ã',
      'rice': '–†–∏—Å',
      'potato': '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å',
      'tomato': '–ü–æ–º–∏–¥–æ—Ä',
      'onion': '–õ—É–∫',
      'garlic': '–ß–µ—Å–Ω–æ–∫',
      'carrot': '–ú–æ—Ä–∫–æ–≤—å',
      'apple': '–Ø–±–ª–æ–∫–æ',
      'banana': '–ë–∞–Ω–∞–Ω',
      'orange': '–ê–ø–µ–ª—å—Å–∏–Ω',
      'lemon': '–õ–∏–º–æ–Ω',
      'cucumber': '–û–≥—É—Ä–µ—Ü',
      'cabbage': '–ö–∞–ø—É—Å—Ç–∞',
      'lettuce': '–°–∞–ª–∞—Ç',
      'spinach': '–®–ø–∏–Ω–∞—Ç',
      'chicken': '–ö—É—Ä–∏—Ü–∞',
      'beef': '–ì–æ–≤—è–¥–∏–Ω–∞',
      'pork': '–°–≤–∏–Ω–∏–Ω–∞',
      'salmon': '–õ–æ—Å–æ—Å—å',
      'mushroom': '–ì—Ä–∏–±—ã',
      'bell pepper': '–ë–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü',
      'broccoli': '–ë—Ä–æ–∫–∫–æ–ª–∏',
      'zucchini': '–ö–∞–±–∞—á–∫–∏'
    };

    // Auto-check services on page load
    checkServices();

    uploadBtn.addEventListener('click', async () => {
      const fileInput = document.getElementById('photoInput');

      if (!fileInput.files.length) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ');
        return;
      }

      const formData = new FormData();
      formData.append('photo', fileInput.files[0]);

      // Show loading state
      showLoading('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã...');
      uploadBtn.disabled = true;
      
      // Reset UI
      resultsEl.style.display = 'none';
      recognizedIngredientsEl.style.display = 'none';
      recipesEl.style.display = 'none';
      usedIngredients.clear();

      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ–¥—ã
        const res = await fetch(`${SERVER_URL}/upload`, {
          method: 'POST',
          body: formData,
          headers: {
            'ngrok-skip-browser-warning': 'true'
          }
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (res.ok && data.ok) {
          hideLoading();
          
          if (data.recognizedFoods && data.recognizedFoods.length > 0) {
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º
            currentIngredients = data.recognizedFoods.map(food => {
              const translatedName = translateFoodName(food.displayName);
              ingredientConfidences[translatedName] = food.confidence;
              return translatedName;
            });
            currentFilename = data.filename;
            
            showRecognizedIngredients();
            statusEl.innerHTML = '<div style="color: #28a745; text-align: center;">‚úÖ –ü—Ä–æ–¥—É–∫—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã! –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–ø–∏—Å–æ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã"</div>';
          } else {
            hideLoading();
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.');
          }
        } else {
          hideLoading();
          showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }
      } catch (err) {
        console.error('Network error details:', err);
        hideLoading();
        
        // More specific error messages
        if (err.message.includes('Failed to fetch')) {
          showError('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        } else if (err.message.includes('timeout')) {
          showError('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        } else {
          showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
      } finally {
        uploadBtn.disabled = false;
      }
    });

    function showLoading(message = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...') {
      statusEl.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>${message}</div>
        </div>
      `;
    }

    function hideLoading() {
      statusEl.innerHTML = '';
    }

    function showError(message) {
      statusEl.innerHTML = `<div class="error">‚ùå ${message}</div>`;
    }

    async function checkServices() {
      console.log('üîç Checking services...');
      
      try {
        const response = await fetch(`${SERVER_URL}/status`, {
          headers: {
            'ngrok-skip-browser-warning': 'true'
          }
        });
        
        if (response.ok) {
          const status = await response.json();
          displayServiceStatus(status);
        } else {
          serviceStatusEl.innerHTML = '<div class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤</div>';
        }
      } catch (error) {
        console.error('Service check failed:', error);
        serviceStatusEl.innerHTML = '<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</div>';
      }
    }

    function displayServiceStatus(status) {
      const isOperational = status.overall.status === 'operational';
      
      let html = `
        <div style="
          background: ${isOperational ? '#d4edda' : '#fff3cd'};
          border: 1px solid ${isOperational ? '#c3e6cb' : '#ffeaa7'};
          color: ${isOperational ? '#155724' : '#856404'};
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 16px;
          font-size: 14px;
        ">
          <div style="font-weight: 600; margin-bottom: 8px;">
            ${status.overall.message}
          </div>
          <div style="font-size: 12px; opacity: 0.8;">
            –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${new Date(status.timestamp).toLocaleTimeString()}
          </div>
        </div>
        <details style="margin-bottom: 16px; font-size: 13px;">
          <summary style="cursor: pointer; font-weight: 500;">üõ†Ô∏è –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</summary>
          <div style="margin-top: 8px; padding-left: 16px;">
      `;
      
      // Show working services only
      const workingServices = status.services.filter(service => service.status === 'available');
      
      if (workingServices.length > 0) {
        html += '<div style="margin-bottom: 12px; font-weight: 500; color: #28a745;">‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã:</div>';
        
        workingServices.forEach(service => {
          html += `
            <div style="margin-bottom: 8px; padding: 8px; background: #e8f5e8; border-radius: 4px; border-left: 3px solid #4caf50;">
              <div style="font-weight: 500;">‚úÖ ${service.name}</div>
              <div style="color: #666; font-size: 12px;">${service.message}</div>
            </div>
          `;
        });
        
        // Show model details for OpenRouter
        const openRouterService = workingServices.find(s => s.name.includes('OpenRouter'));
        if (openRouterService) {
          html += `
            <div style="margin-top: 12px; padding: 8px; background: #f0f9ff; border-radius: 4px;">
              <div style="font-weight: 500; color: #0369a1; margin-bottom: 4px;">ü§ñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤:</div>
              <div style="font-size: 11px; color: #666;">
                ‚Ä¢ Llama 3.2 3B (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)<br>
                ‚Ä¢ Gemma 2 9B (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)<br>
                ‚Ä¢ Mistral 7B (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)<br>
                ‚Ä¢ Claude 3 Haiku (–ø–ª–∞—Ç–Ω–∞—è)<br>
                ‚Ä¢ GPT-3.5 Turbo (–ø–ª–∞—Ç–Ω–∞—è)
              </div>
            </div>
          `;
        }
        
        // Show vision model details
        const visionService = workingServices.find(s => s.name.includes('Vision') || s.name.includes('Ninjas'));
        if (visionService) {
          html += `
            <div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 4px;">
              <div style="font-weight: 500; color: #0369a1; margin-bottom: 4px;">üëÅÔ∏è –ú–æ–¥–µ–ª—å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –µ–¥—ã:</div>
              <div style="font-size: 11px; color: #666;">
                ‚Ä¢ API Ninjas Image Analysis (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)
              </div>
            </div>
          `;
        }
      }
      
      const nonWorkingServices = status.services.filter(service => service.status !== 'available');
      if (nonWorkingServices.length > 0) {
        html += '<div style="margin-top: 12px; margin-bottom: 8px; font-weight: 500; color: #dc3545;">‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:</div>';
        
        nonWorkingServices.forEach(service => {
          if (!service.name.includes('HuggingFace')) { // Skip old HuggingFace references
            html += `
              <div style="margin-bottom: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                <div style="font-weight: 500;">‚ö†Ô∏è ${service.name}</div>
                <div style="color: #666; font-size: 12px;">${service.message}</div>
              </div>
            `;
          }
        });
      }
      
      html += `
          </div>
        </details>
      `;
      
      serviceStatusEl.innerHTML = html;
      serviceStatusEl.style.display = 'block';
    }

    // Translation function
    function translateFoodName(englishName) {
      const lowerName = englishName.toLowerCase();
      return foodTranslations[lowerName] || englishName;
    }

    // New combined ingredients interface
    function showRecognizedIngredients() {
      resultsEl.style.display = 'block';
      recognizedIngredientsEl.style.display = 'block';
      updateIngredientsEditor();
    }

    function updateIngredientsEditor() {
      ingredientsListEl.innerHTML = currentIngredients.map((ingredient, index) => {
        const confidence = ingredientConfidences[ingredient];
        const isUsedInRecipe = usedIngredients.has(ingredient.toLowerCase());
        
        return `
          <div class="ingredient-item ${isUsedInRecipe ? 'used-in-recipe' : ''}" id="ingredient-${index}">
            ${isUsedInRecipe ? '<span class="used-check">‚úì</span>' : ''}
            <span class="ingredient-name">${ingredient}</span>
            ${confidence ? `<span class="ingredient-confidence">${Math.round(confidence * 100)}%</span>` : ''}
            <div class="ingredient-actions">
              <button class="ingredient-btn edit-btn" onclick="editIngredient(${index})">‚úèÔ∏è</button>
              <button class="ingredient-btn delete-btn" onclick="deleteIngredient(${index})">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function displayRecipes(recipes) {
      // Mark ingredients used in recipes
      usedIngredients.clear();
      recipes.forEach(recipe => {
        if (recipe.ingredients) {
          recipe.ingredients.forEach(ingredient => {
            const lowerIngredient = ingredient.toLowerCase();
            currentIngredients.forEach(currentIng => {
              if (lowerIngredient.includes(currentIng.toLowerCase()) || 
                  currentIng.toLowerCase().includes(lowerIngredient.split(' ')[0])) {
                usedIngredients.add(currentIng.toLowerCase());
              }
            });
          });
        }
      });
      
      // Update ingredients list to show checkmarks
      updateIngredientsEditor();
      
      recipeListEl.innerHTML = recipes.map(recipe => `
        <div class="recipe">
          <div class="recipe-title">${recipe.name || recipe.title || 'Unnamed Recipe'}</div>
          <div class="recipe-description">${recipe.description}</div>
          <div class="recipe-meta">
            <div class="cooking-time">‚è± ${recipe.cookingTime}</div>
          </div>
          ${recipe.mainIngredients && recipe.mainIngredients.length > 0 ? `
            <div class="ingredients">
              <div class="ingredients-title">–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div>
              <div class="ingredients-list">${recipe.mainIngredients.join(', ')}</div>
            </div>
          ` : ''}
          <div class="instructions">
            <div class="instructions-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</div>
            ${recipe.instructions.map(step => `
              <div class="instruction-step">${step}</div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function editIngredient(index) {
      const ingredientEl = document.getElementById(`ingredient-${index}`);
      const currentName = currentIngredients[index];
      
      ingredientEl.innerHTML = `
        <input type="text" class="ingredient-input" value="${currentName}" id="edit-input-${index}">
        <div class="ingredient-actions">
          <button class="ingredient-btn save-btn" onclick="saveIngredient(${index})">‚úì</button>
          <button class="ingredient-btn delete-btn" onclick="cancelEdit(${index})">‚úñ</button>
        </div>
      `;
      
      ingredientEl.classList.add('editing');
      document.getElementById(`edit-input-${index}`).focus();
    }

    function saveIngredient(index) {
      const input = document.getElementById(`edit-input-${index}`);
      const newName = input.value.trim();
      
      if (newName && newName !== currentIngredients[index]) {
        // Update confidence mapping
        const oldName = currentIngredients[index];
        if (ingredientConfidences[oldName]) {
          ingredientConfidences[newName] = ingredientConfidences[oldName];
          delete ingredientConfidences[oldName];
        }
        currentIngredients[index] = newName;
      }
      
      updateIngredientsEditor();
    }

    function cancelEdit(index) {
      updateIngredientsEditor();
    }

    function deleteIngredient(index) {
      const deletedName = currentIngredients[index];
      delete ingredientConfidences[deletedName];
      currentIngredients.splice(index, 1);
      updateIngredientsEditor();
    }

    function addIngredient() {
      const input = document.getElementById('newIngredient');
      const newIngredient = input.value.trim();
      
      if (newIngredient && !currentIngredients.includes(newIngredient)) {
        currentIngredients.push(newIngredient);
        ingredientConfidences[newIngredient] = 0.8; // Default confidence for manually added ingredients
        input.value = '';
        updateIngredientsEditor();
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
    document.addEventListener('DOMContentLoaded', function() {
      const newIngredientInput = document.getElementById('newIngredient');
      if (newIngredientInput) {
        newIngredientInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            addIngredient();
          }
        });
      }
    });

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
    async function generateRecipes() {
      if (currentIngredients.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç');
        return;
      }

      showLoading('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ—Ü–µ–ø—Ç—ã...');
      generateRecipesBtnEl.disabled = true;
      recipesEl.style.display = 'none';

      try {
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const ingredientsData = currentIngredients.map(name => ({
          label: name.toLowerCase().replace(/\s+/g, '_'),
          displayName: name,
          confidence: 0.8
        }));

        const requestData = {
          ingredients: ingredientsData,
          filename: currentFilename
        };

        const response = await fetch(`${SERVER_URL}/generate-recipes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify(requestData)
        });

        let data = {};
        try { data = await response.json(); } catch (_) {}

        if (response.ok && data.ok) {
          hideLoading();
          
          if (data.recipes && data.recipes.length > 0) {
            displayRecipes(data.recipes);
            recipesEl.style.display = 'block';
            statusEl.innerHTML = '<div style="color: #28a745; text-align: center;">‚úÖ –†–µ—Ü–µ–ø—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!</div>';
          } else {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          }
        } else {
          hideLoading();
          showError(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤');
        }
      } catch (error) {
        console.error('Recipe generation error:', error);
        hideLoading();
        showError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      } finally {
        generateRecipesBtnEl.disabled = false;
      }
    }
  </script>
</body>
</html>
