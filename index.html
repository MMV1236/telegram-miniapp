<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FoodLens Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 16px;
      margin: 0;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 { 
      color: #333; 
      text-align: center;
      margin-bottom: 8px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 24px;
      font-size: 14px;
    }
    .upload-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, button {
      padding: 12px;
      font-size: 16px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="file"] {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #fafafa;
    }
    button {
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover {
      background: #006ba3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .results {
      margin-top: 20px;
    }
    .food-items {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .food-item:last-child {
      border-bottom: none;
    }
    .food-name {
      font-weight: 500;
      color: #333;
    }
    .confidence {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .recipes {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .recipe {
      padding: 16px;
      border-bottom: 1px solid #eee;
    }
    .recipe:last-child {
      border-bottom: none;
    }
    .recipe-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .recipe-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .recipe-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .cooking-time {
      background: #f0f9ff;
      color: #0369a1;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    .ingredients {
      margin-bottom: 12px;
    }
    .ingredients-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    .ingredients-list {
      color: #666;
      font-size: 13px;
    }
    .instructions {
      font-size: 13px;
    }
    .instructions-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .instruction-step {
      color: #666;
      margin-bottom: 4px;
      padding-left: 16px;
      position: relative;
    }
    .instruction-step:before {
      content: counter(step-counter);
      counter-increment: step-counter;
      position: absolute;
      left: 0;
      background: #0088cc;
      color: white;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      font-size: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      top: 2px;
    }
    .instructions {
      counter-reset: step-counter;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0088cc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üçΩ FoodLens</h1>
    <p class="subtitle">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç—ã!</p>
    
    <div class="upload-section">
      <div id="serviceStatus" style="display: none;"></div>
      <input id="photoInput" type="file" accept="image/*" capture="environment" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ">
      <button id="uploadBtn">üì∑ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</button>
      <button id="checkServicesBtn" style="background: #6c757d; margin-top: 5px;">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã</button>
      <div id="status"></div>
    </div>

    <div id="results" class="results" style="display: none;">
      <div id="foodItems" style="display: none;">
        <div class="section-title">
          ü•ó –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
        </div>
        <div class="food-items" id="foodList"></div>
      </div>

      <div id="recipes" style="display: none;">
        <div class="section-title">
          üë®‚Äçüç≥ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã
        </div>
        <div class="recipes" id="recipeList"></div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–≥–æ ngrok-—Ç—É–Ω–Ω–µ–ª—è
    const SERVER_URL = 'https://8838f8430a6a.ngrok-free.app';

    const uploadBtn = document.getElementById('uploadBtn');
    const checkServicesBtn = document.getElementById('checkServicesBtn');
    const statusEl = document.getElementById('status');
    const serviceStatusEl = document.getElementById('serviceStatus');
    const resultsEl = document.getElementById('results');
    const foodItemsEl = document.getElementById('foodItems');
    const recipesEl = document.getElementById('recipes');
    const foodListEl = document.getElementById('foodList');
    const recipeListEl = document.getElementById('recipeList');

    // Check services on page load
    checkServices();

    checkServicesBtn.addEventListener('click', checkServices);

    uploadBtn.addEventListener('click', async () => {
      const fileInput = document.getElementById('photoInput');

      if (!fileInput.files.length) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ');
        return;
      }

      const formData = new FormData();
      formData.append('photo', fileInput.files[0]);

      // Show loading state
      showLoading();
      uploadBtn.disabled = true;
      resultsEl.style.display = 'none';

      try {
        const res = await fetch(`${SERVER_URL}/upload`, {
          method: 'POST',
          body: formData,
          headers: {
            'ngrok-skip-browser-warning': 'true'
          }
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (res.ok && data.ok) {
          hideLoading();
          displayResults(data);
        } else {
          hideLoading();
          showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        }
      } catch (err) {
        console.error('Network error details:', err);
        hideLoading();
        
        // More specific error messages
        if (err.message.includes('Failed to fetch')) {
          showError('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        } else if (err.message.includes('timeout')) {
          showError('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        } else {
          showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
      } finally {
        uploadBtn.disabled = false;
      }
    });

    function showLoading() {
      statusEl.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</div>
        </div>
      `;
    }

    function hideLoading() {
      statusEl.innerHTML = '';
    }

    function showError(message) {
      statusEl.innerHTML = `<div class="error">‚ùå ${message}</div>`;
    }

    async function checkServices() {
      console.log('üîç Checking services...');
      checkServicesBtn.disabled = true;
      checkServicesBtn.textContent = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
      
      try {
        const response = await fetch(`${SERVER_URL}/status`, {
          headers: {
            'ngrok-skip-browser-warning': 'true'
          }
        });
        
        if (response.ok) {
          const status = await response.json();
          displayServiceStatus(status);
        } else {
          serviceStatusEl.innerHTML = '<div class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤</div>';
        }
      } catch (error) {
        console.error('Service check failed:', error);
        serviceStatusEl.innerHTML = '<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</div>';
      } finally {
        checkServicesBtn.disabled = false;
        checkServicesBtn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã';
      }
    }

    function displayServiceStatus(status) {
      const isOperational = status.overall.status === 'operational';
      
      let html = `
        <div style="
          background: ${isOperational ? '#d4edda' : '#fff3cd'};
          border: 1px solid ${isOperational ? '#c3e6cb' : '#ffeaa7'};
          color: ${isOperational ? '#155724' : '#856404'};
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 16px;
          font-size: 14px;
        ">
          <div style="font-weight: 600; margin-bottom: 8px;">
            ${status.overall.message}
          </div>
          <div style="font-size: 12px; opacity: 0.8;">
            –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${new Date(status.timestamp).toLocaleTimeString()}
          </div>
        </div>
        <details style="margin-bottom: 16px; font-size: 13px;">
          <summary style="cursor: pointer; font-weight: 500;">üõ†Ô∏è –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</summary>
          <div style="margin-top: 8px; padding-left: 16px;">
      `;
      
      status.services.forEach(service => {
        const statusIcon = service.status === 'available' ? '‚úÖ' : 
                          service.status === 'not_configured' ? '‚ö†Ô∏è' : '‚ùå';
        
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
            <div style="font-weight: 500;">${statusIcon} ${service.name}</div>
            <div style="color: #666; font-size: 12px;">${service.message}</div>
          </div>
        `;
      });
      
      html += `
          </div>
        </details>
      `;
      
      serviceStatusEl.innerHTML = html;
      serviceStatusEl.style.display = 'block';
    }

    function displayResults(data) {
      resultsEl.style.display = 'block';
      
      // Display recognized foods
      if (data.recognizedFoods && data.recognizedFoods.length > 0) {
        displayFoods(data.recognizedFoods);
        foodItemsEl.style.display = 'block';
      } else {
        foodItemsEl.style.display = 'none';
        if (data.recognitionError) {
          showError(`–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${data.recognitionError}`);
        } else {
          statusEl.innerHTML = '<div style="color: #f39c12; text-align: center;">ü§î –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ —á–∞—Ç–µ –±–æ—Ç–∞.</div>';
        }
      }

      // Display recipes
      if (data.recipes && data.recipes.length > 0) {
        displayRecipes(data.recipes);
        recipesEl.style.display = 'block';
      } else {
        recipesEl.style.display = 'none';
        if (data.recipeError && data.recognizedFoods && data.recognizedFoods.length > 0) {
          showError(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤: ${data.recipeError}`);
        }
      }

      if (!data.recognizedFoods?.length && !data.recipes?.length) {
        statusEl.innerHTML = '<div class="error">üòï –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.</div>';
      } else {
        statusEl.innerHTML = '<div style="color: #28a745; text-align: center;">‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>';
      }
    }

    function displayFoods(foods) {
      foodListEl.innerHTML = foods.map(food => `
        <div class="food-item">
          <span class="food-name">${food.displayName}${food.suggested ? ' ü§ñ' : ''}</span>
          <span class="confidence">${Math.round(food.confidence * 100)}%</span>
        </div>
      `).join('');
    }

    function displayRecipes(recipes) {
      recipeListEl.innerHTML = recipes.map(recipe => `
        <div class="recipe">
          <div class="recipe-title">${recipe.name}</div>
          <div class="recipe-description">${recipe.description}</div>
          <div class="recipe-meta">
            <div class="cooking-time">‚è± ${recipe.cookingTime}</div>
          </div>
          ${recipe.mainIngredients && recipe.mainIngredients.length > 0 ? `
            <div class="ingredients">
              <div class="ingredients-title">–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div>
              <div class="ingredients-list">${recipe.mainIngredients.join(', ')}</div>
            </div>
          ` : ''}
          <div class="instructions">
            <div class="instructions-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</div>
            ${recipe.instructions.map(step => `
              <div class="instruction-step">${step}</div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
