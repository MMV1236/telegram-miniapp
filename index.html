<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'; script-src 'self' https: 'unsafe-inline' 'unsafe-eval'; connect-src *;">
  <title>FoodLens Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .header {
      background: #4CAF50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .content {
      padding: 30px;
    }
    h1 { 
      margin: 0;
      font-size: 28px;
    }
    .upload-section {
      text-align: center;
      margin-bottom: 30px;
    }
    input[type="file"] {
      display: none;
    }
    .file-label {
      display: inline-block;
      padding: 15px 30px;
      background: #2196F3;
      color: white;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px;
    }
    .file-label:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }
    button {
      padding: 15px 40px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px;
    }
    button:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    #status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
    }
    .status-loading {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #2196F3;
    }
    .status-success {
      background: #e8f5e8;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }
    .status-error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    .results {
      margin-top: 30px;
    }
    .detected-items {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .detected-items h3 {
      margin-top: 0;
      color: #333;
    }
    .item-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .item-tag {
      background: #4CAF50;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
    }
    .recipes {
      margin-top: 20px;
    }
    .recipe-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .recipe-header {
      background: #f5f5f5;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
    }
    .recipe-title {
      margin: 0;
      font-size: 20px;
      color: #333;
    }
    .recipe-meta {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .recipe-body {
      padding: 20px;
    }
    .recipe-section {
      margin-bottom: 20px;
    }
    .recipe-section h4 {
      margin: 0 0 10px 0;
      color: #4CAF50;
    }
    .ingredients-list {
      list-style: none;
      padding: 0;
    }
    .ingredients-list li {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    .instructions-list {
      counter-reset: step-counter;
      list-style: none;
      padding: 0;
    }
    .instructions-list li {
      counter-increment: step-counter;
      margin-bottom: 15px;
      padding-left: 40px;
      position: relative;
    }
    .instructions-list li::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      background: #4CAF50;
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è FoodLens</h1>
      <p>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é –ò–ò</p>
    </div>
    
    <div class="content">
      <div class="upload-section">
        <p>–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</p>
        <label for="photoInput" class="file-label">
          üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
        </label>
        <input id="photoInput" name="photoInput" type="file" accept="image/*" capture="environment">
        <br>
        <button id="analyzeBtn" type="button">üîç –ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—ã</button>
      </div>

      <div id="status"></div>
      
      <div id="results" class="results hidden">
        <div id="detectedItems" class="detected-items">
          <h3>ü•¨ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:</h3>
          <div id="itemsList" class="item-list"></div>
        </div>
        
        <div id="recipes" class="recipes">
          <h3>üë®‚Äçüç≥ –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã:</h3>
          <div id="recipesList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–≥–æ ngrok-—Ç—É–Ω–Ω–µ–ª—è
    const SERVER_URL = 'https://320a1ce162f1.ngrok-free.app';

    const analyzeBtn = document.getElementById('analyzeBtn');
    const fileInput = document.getElementById('photoInput');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const itemsListEl = document.getElementById('itemsList');
    const recipesListEl = document.getElementById('recipesList');

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = `status-${type}`;
      if (type === 'loading') {
        statusEl.innerHTML = `<div class="loading-spinner"></div>${message}`;
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    function displayDetectedItems(items) {
      itemsListEl.innerHTML = '';
      
      if (!items || !items.length) {
        itemsListEl.innerHTML = '<p>–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>';
        return;
      }

      items.forEach(item => {
        const itemTag = document.createElement('div');
        itemTag.className = 'item-tag';
        const confidence = Math.round(item.confidence * 100);
        itemTag.textContent = `${item.name} (${confidence}%)`;
        itemsListEl.appendChild(itemTag);
      });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    function displayRecipes(recipes) {
      recipesListEl.innerHTML = '';
      
      if (!recipes || !recipes.length) {
        recipesListEl.innerHTML = '<p>–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
      }

      recipes.forEach(recipe => {
        const recipeCard = document.createElement('div');
        recipeCard.className = 'recipe-card';
        
        recipeCard.innerHTML = `
          <div class="recipe-header">
            <h3 class="recipe-title">${recipe.title}</h3>
            <div class="recipe-meta">
              ‚è∞ ${recipe.cookingTime} | üéñÔ∏è ${recipe.difficulty}
            </div>
          </div>
          <div class="recipe-body">
            <div class="recipe-section">
              <h4>ü•¨ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</h4>
              <ul class="ingredients-list">
                ${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}
              </ul>
            </div>
            <div class="recipe-section">
              <h4>üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</h4>
              <ol class="instructions-list">
                ${recipe.instructions.map(inst => `<li>${inst}</li>`).join('')}
              </ol>
            </div>
          </div>
        `;
        
        recipesListEl.appendChild(recipeCard);
      });
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞
    analyzeBtn.addEventListener('click', async () => {
      console.log('–ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–∂–∞—Ç–∞');
      
      if (!fileInput.files.length) {
        console.log('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
        updateStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ', 'error');
        return;
      }

      console.log('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω:', fileInput.files[0].name);
      const formData = new FormData();
      formData.append('photo', fileInput.files[0]);

      // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
      resultsEl.classList.add('hidden');
      
      updateStatus('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã...', 'loading');
      analyzeBtn.disabled = true;

      console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞:', `${SERVER_URL}/analyze`);
      
      try {
        const response = await fetch(`${SERVER_URL}/analyze`, {
          method: 'POST',
          body: formData,
          headers: {
            'ngrok-skip-browser-warning': 'true'
          }
        });

        console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Å—Ç–∞—Ç—É—Å:', response.status);
        const result = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', result);

        if (!response.ok) {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        if (result.ok && result.analysis) {
          updateStatus('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          displayDetectedItems(result.analysis.detectedItems);
          displayRecipes(result.analysis.recipes);
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          resultsEl.classList.remove('hidden');
          
          // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
          setTimeout(() => {
            resultsEl.scrollIntoView({ behavior: 'smooth' });
          }, 300);
          
        } else {
          throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
        updateStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
        
      } finally {
        analyzeBtn.disabled = false;
      }
    });

    // –ü–æ–∫–∞–∑ –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        const fileName = e.target.files[0].name;
        updateStatus(`–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${fileName}`, 'success');
      }
    });
  </script>
</body>
</html>
